---
title: "Ph√¢n t√≠ch b·ªánh nh√¢n thi·∫øu m√°u do thi·∫øu s·∫Øt (D50)"
author: "Nh√≥m 5"
date: "2025-06-18"
output:
  word_document:
    toc: true
    toc_depth: 3
    number_sections: true
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
  pdf_document:
    toc: true
    toc_depth: 3
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# **I. ƒê·ªåC V√Ä TI·ªÄN X·ª¨ L√ù D·ªÆ LI·ªÜU THEO CH·ª¶ ƒê·ªÄ D50: THI·∫æU M√ÅU DO THI·∫æU S·∫ÆT (G·ªíM C√ÅC M√É B·ªÜNH NH√ÇN: D500, D508 v√† D509)**

## üîπ 1.1. K·∫øt n·ªëi v·ªõi Google Drive

Trong R Markdown, vi·ªác k·∫øt n·ªëi v·ªõi Google Drive kh√¥ng gi·ªëng nh∆∞ Colab. Thay v√†o ƒë√≥, b·∫°n s·∫Ω truy c·∫≠p tr·ª±c ti·∫øp c√°c t·ªáp t·ª´ ƒë∆∞·ªùng d·∫´n c·ª•c b·ªô.

N·∫øu b·∫°n mu·ªën ƒë·ªçc file t·ª´ Google Drive, b·∫°n s·∫Ω c·∫ßn s·ª≠ d·ª•ng c√°c package nh∆∞ `googledrive` ho·∫∑c t·∫£i xu·ªëng th·ªß c√¥ng file v·ªÅ m√°y c·ª•c b·ªô. ƒê·ªëi v·ªõi b√†i t·∫≠p n√†y, ch√∫ng ta s·∫Ω gi·∫£ ƒë·ªãnh c√°c file ƒë√£ ƒë∆∞·ª£c t·∫£i v·ªÅ v√† ƒë·∫∑t t·∫°i `D:/Downloads/Data2`.

## üîπ 1.2. Nh·∫≠p c√°c th∆∞ vi·ªán c·∫ßn thi·∫øt

Trong R, ch√∫ng ta s·∫Ω s·ª≠ d·ª•ng c√°c package t∆∞∆°ng ƒë∆∞∆°ng ƒë·ªÉ x·ª≠ l√Ω v√† ph√¢n t√≠ch d·ªØ li·ªáu.

```{r setup, include=FALSE}
# C√†i ƒë·∫∑t v√† t·∫£i c√°c th∆∞ vi·ªán c·∫ßn thi·∫øt
if (!requireNamespace("tidyverse", quietly = TRUE)) install.packages("tidyverse")
if (!requireNamespace("readxl", quietly = TRUE)) install.packages("readxl")
if (!requireNamespace("dplyr", quietly = TRUE)) install.packages("dplyr")
if (!requireNamespace("stringr", quietly = TRUE)) install.packages("stringr")
if (!requireNamespace("lubridate", quietly = TRUE)) install.packages("lubridate")
if (!requireNamespace("ggplot2", quietly = TRUE)) install.packages("ggplot2")
if (!requireNamespace("car", quietly = TRUE)) install.packages("car") # For Levene's test
if (!requireNamespace("ggpubr", quietly = TRUE)) install.packages("ggpubr") # For stat_compare_means
if (!requireNamespace("broom", quietly = TRUE)) install.packages("broom") # For tidy()
if (!requireNamespace("rstatix", quietly = TRUE)) install.packages("rstatix") # For t_test
install.packages("openxlsx")


library(tidyverse)
library(readxl)
library(dplyr)
library(stringr)
library(lubridate)
library(ggplot2)
library(car)
library(ggpubr)
library(broom)
library(rstatix) # For t_test
library(knitr)
```
## üîπ 1.3. ƒê·ªçc d·ªØ li·ªáu
```{r}
# ƒê∆∞·ªùng d·∫´n th∆∞ m·ª•c trong m√°y t√≠nh
path <- "D:/Downloads/Data2/"

# ƒê·ªçc d·ªØ li·ªáu t·ª´ file Excel
admission_df <- read_excel(paste0(path, "admission.xlsx"))
diagnosis_df <- read_excel(paste0(path, "diagnosis.xlsx"))

# Hi·ªÉn th·ªã m·ªôt ph·∫ßn d·ªØ li·ªáu
cat("üìÑ TO√ÄN B·ªò B·∫¢NG ADMISSION (20 d√≤ng ng·∫´u nhi√™n):\n")
kable(admission_df %>% sample_n(20))

cat("\nüìÑ TO√ÄN B·ªò B·∫¢NG DIAGNOSIS (20 d√≤ng ng·∫´u nhi√™n):\n")
kable(diagnosis_df %>% sample_n(20)) 
```
## üîπ 1.4. L·ªçc c√°c ch·∫©n ƒëo√°n theo m√£ ICD10
Nh√≥m t·∫≠p trung ph√¢n t√≠ch c√°c b·ªánh nh√¢n c√≥ m√£ ch·∫©n ƒëo√°n:
- D500: Thi·∫øu m√°u thi·∫øu s·∫Øt do m·∫•t m√°u m·∫°n t√≠nh
- D508: Thi·∫øu m√°u thi·∫øu s·∫Øt kh√°c
- D509: Thi·∫øu m√°u thi·∫øu s·∫Øt kh√¥ng x√°c ƒë·ªãnh

```{r}
# L·ªçc c√°c m√£ ICD10 l√† D500, D508, D509
target_icds <- c("D500", "D508", "D509")
filtered_diag <- diagnosis_df %>% filter(diagnosis %in% target_icds)
```
## üîπ 1.5. L·∫•y danh s√°ch c√°c admission_id t∆∞∆°ng ·ª©ng
T·ª´ b·∫£ng diagnosis ƒë√£ l·ªçc, ch√∫ng t√¥i tr√≠ch ra t·∫•t c·∫£ c√°c admission_id li√™n quan ƒë·∫øn c√°c b·ªánh nh√¢n mang m√£ D500, D508, D509.

```{r}
# L·∫•y danh s√°ch ID ph√π h·ª£p
matching_ids <- unique(filtered_diag$admission_id)
```
## üîπ 1.6. L·ªçc b·∫£ng Admission v√† Diagnosis t∆∞∆°ng ·ª©ng
T·ª´ b·∫£ng admission, ch·ªâ gi·ªØ l·∫°i nh·ªØng d√≤ng c√≥ admission_id t∆∞∆°ng ·ª©ng v·ªõi c√°c b·ªánh nh√¢n ƒë√£ ƒë∆∞·ª£c l·ªçc.

```{r}
# L·ªçc admission t∆∞∆°ng ·ª©ng v·ªõi c√°c ID
filtered_admission <- admission_df %>% filter(admission_id %in% matching_ids)

```

## üîπ 1.7. Xu·∫•t file Excel k·∫øt qu·∫£
D·ªØ li·ªáu sau khi l·ªçc ƒë∆∞·ª£c l∆∞u v√†o file m·ªõi: filtered_admission.xlsx v√† diagnosis_chi_D500_D508_D509.xlsx

```{r}
# Xu·∫•t file k·∫øt qu·∫£
library(openxlsx)

write.xlsx(filtered_admission, paste0(path, "filtered_admission.xlsx"))
cat("‚úÖ File filtered_admission.xlsx ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o th∆∞ m·ª•c.\n")

write.xlsx(filtered_diag, paste0(path, "diagnosis_chi_D500_D508_D509.xlsx"))
cat("‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng file diagnosis_chi_D500_D508_D509.xlsx\n")
```

## üîπ 1.8. Ki·ªÉm tra ƒë·ªô nh·∫•t qu√°n d·ªØ li·ªáu
Ki·ªÉm tra t√≠nh nh·∫•t qu√°n c·ªßa d·ªØ li·ªáu b·∫±ng c√°ch so s√°nh c√°c m√£ ƒë·ªãnh danh gi·ªØa c√°c b·∫£ng g·ªëc v√† b·∫£ng ƒë√£ l·ªçc.

```{r}
# Ki·ªÉm tra admission_id
original_ids <- unique(admission_df$admission_id)
filtered_ids <- unique(filtered_admission$admission_id)

if (all(filtered_ids %in% original_ids)) {
  cat("‚úÖ T·∫•t c·∫£ admission_id trong file l·ªçc ƒë·ªÅu tr√πng kh·ªõp v·ªõi file g·ªëc.\n")
} else {
  missing_ids <- setdiff(filtered_ids, original_ids)
  cat("‚ö†Ô∏è M·ªôt s·ªë admission_id kh√¥ng t√¨m th·∫•y trong file g·ªëc:\n")
  print(missing_ids)
}

# Ki·ªÉm tra ch·∫©n ƒëo√°n (Diagnosis)
original_diag_ids <- unique(diagnosis_df$diagnosis)
filtered_diag_ids <- unique(filtered_diag$diagnosis)

if (all(filtered_diag_ids %in% original_diag_ids)) {
  cat("‚úÖ T·∫•t c·∫£ ID trong file diagnosis ƒë√£ l·ªçc ƒë·ªÅu tr√πng kh·ªõp v·ªõi file g·ªëc.\n")
} else {
  missing_diag_ids <- setdiff(filtered_diag_ids, original_diag_ids)
  cat("‚ö†Ô∏è M·ªôt s·ªë ID kh√¥ng t√¨m th·∫•y trong file diagnosis g·ªëc:\n")
  print(missing_diag_ids)
}
```

## üîπ 1.9. Hi·ªÉn th·ªã b·∫£ng admission v√† diagnosis sau khi l·ªçc
```{r}
# Hi·ªÉn th·ªã to√†n b·ªô b·∫£ng admission sau khi l·ªçc
cat("\nüìã D·ªØ li·ªáu admission ƒë√£ l·ªçc:\n")
kable(filtered_admission)  

# Hi·ªÉn th·ªã to√†n b·ªô b·∫£ng diagnosis sau khi l·ªçc
cat("\nüìã D·ªØ li·ªáu diagnosis ƒë√£ l·ªçc:\n")
kable(filtered_diag)  
```


# **II. TH·ªêNG K√ä T·ªîNG QUAN TO√ÄN B·ªò D·ªÆ LI·ªÜU**
## üîπ 2.1. ƒê·ªçc d·ªØ li·ªáu t·ª´ file ƒë√£ l·ªçc
```{r}
library(readxl)
library(dplyr)
library(ggplot2)

# ƒê∆∞·ªùng d·∫´n th∆∞ m·ª•c
path <- "D:/Downloads/Data2/"

# ƒê·ªçc d·ªØ li·ªáu ƒë√£ l·ªçc
filtered_admission <- read_excel(paste0(path, "filtered_admission.xlsx"))
diagnosis_filtered <- read_excel(paste0(path, "diagnosis_chi_D500_D508_D509.xlsx"))
```

##üîπ 2.2. Th·ªëng k√™ m√¥ t·∫£
###üîπ 2.2.1. Ph√¢n b·ªë gi·ªõi t√≠nh
```{r}
# Chuy·ªÉn ƒë·ªïi m√£ gi·ªõi t√≠nh
filtered_admission <- filtered_admission %>%
  mutate(Gender = case_when(
    Gender == 1 ~ "Nam",
    Gender == 2 ~ "N·ªØ",
    TRUE ~ "Kh√¥ng x√°c ƒë·ªãnh"
  ))

# Th·ªëng k√™ gi·ªõi t√≠nh
gender_stats <- filtered_admission %>%
  count(Gender) %>%
  mutate(Percentage = n / sum(n) * 100)

# Bi·ªÉu ƒë·ªì ph√¢n b·ªë gi·ªõi t√≠nh
ggplot(gender_stats, aes(x = Gender, y = n, fill = Gender)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(round(Percentage, 1), "%")), vjust = -0.5) +
  labs(title = "Ph√¢n b·ªë gi·ªõi t√≠nh b·ªánh nh√¢n thi·∫øu m√°u do thi·∫øu s·∫Øt",
       x = "Gi·ªõi t√≠nh", y = "S·ªë l∆∞·ª£ng") +
  theme_minimal()
```
###üîπ 2.2.2. Ph√¢n b·ªë tu·ªïi
```{r}
# Ph√¢n t√≠ch ƒë·ªô tu·ªïi
age_stats <- filtered_admission %>%
  summarise(
    Mean = mean(age_years, na.rm = TRUE),
    Median = median(age_years, na.rm = TRUE),
    SD = sd(age_years, na.rm = TRUE),
    Min = min(age_years, na.rm = TRUE),
    Max = max(age_years, na.rm = TRUE)
  )

# Ph√¢n nh√≥m tu·ªïi theo c√°ch c·ªßa Python (0-9, 10-19, ..., 60+)
filtered_admission <- filtered_admission %>%
  mutate(age_group = cut(age_years,
                         breaks = c(0, 10, 20, 30, 40, 50, 60, Inf),
                         labels = c("0-9", "10-19", "20-29", "30-39", "40-49", "50-59", "60+"),
                         right = FALSE)) # S·ª≠ d·ª•ng right=FALSE ƒë·ªÉ bao g·ªìm ƒëi·ªÉm ƒë·∫ßu, kh√¥ng bao g·ªìm ƒëi·ªÉm cu·ªëi

# Bi·ªÉu ƒë·ªì ph√¢n b·ªë ƒë·ªô tu·ªïi (histogram)
ggplot(filtered_admission, aes(x = age_years)) +
  geom_histogram(binwidth = 5, fill = "steelblue", color = "white") +
  labs(title = "Ph√¢n b·ªë ƒë·ªô tu·ªïi b·ªánh nh√¢n thi·∫øu m√°u do thi·∫øu s·∫Øt",
       x = "Tu·ªïi", y = "S·ªë l∆∞·ª£ng") +
  theme_minimal() +
  geom_vline(xintercept = c(10, 20, 30, 40, 50, 60), linetype = "dashed", color = "red") # Th√™m ƒë∆∞·ªùng k·∫ª ph√¢n nh√≥m

# Bi·ªÉu ƒë·ªì ph√¢n b·ªë theo nh√≥m tu·ªïi (bar chart)
age_group_stats <- filtered_admission %>%
  count(age_group) %>%
  mutate(Percentage = n / sum(n) * 100)

ggplot(age_group_stats, aes(x = age_group, y = n, fill = age_group)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(round(Percentage, 1), "%")), vjust = -0.5) +
  labs(title = "Ph√¢n b·ªë b·ªánh nh√¢n theo nh√≥m tu·ªïi",
       x = "Nh√≥m tu·ªïi", y = "S·ªë l∆∞·ª£ng") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_x_discrete(limits = c("0-9", "10-19", "20-29", "30-39", "40-49", "50-59", "60+")) # ƒê·∫£m b·∫£o th·ª© t·ª± nh√≥m tu·ªïi
```

###üîπ 2.2.3.Th·ªùi gian n·∫±m vi·ªán (LOS)
```{r}
# Th·ªëng k√™ t·ªïng quan th·ªùi gian n·∫±m vi·ªán
los_stats <- filtered_admission %>%
  summarise(
    Mean = round(mean(los, na.rm = TRUE), 2),
    Median = median(los, na.rm = TRUE),
    SD = round(sd(los, na.rm = TRUE), 2),
    Min = min(los, na.rm = TRUE),
    Max = max(los, na.rm = TRUE),
    N = n()
  )

# In k·∫øt qu·∫£ th·ªëng k√™
print("Th·ªëng k√™ t·ªïng quan th·ªùi gian n·∫±m vi·ªán:")
print(los_stats)

# Bi·ªÉu ƒë·ªì ph√¢n b·ªë LOS t·ªïng th·ªÉ
ggplot(filtered_admission, aes(x = los)) +
  geom_histogram(binwidth = 1, fill = "steelblue", color = "white", alpha = 0.8) +
  geom_vline(aes(xintercept = mean(los, na.rm = TRUE)), 
             color = "red", linetype = "dashed", linewidth = 1) +
  labs(title = "Ph√¢n b·ªë th·ªùi gian n·∫±m vi·ªán (LOS)",
       x = "S·ªë ng√†y n·∫±m vi·ªán", y = "S·ªë l∆∞·ª£ng b·ªánh nh√¢n") +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(hjust = 0.5))

# Ph√¢n t√≠ch LOS theo nh√≥m tu·ªïi
los_by_age <- filtered_admission %>%
  group_by(age_group) %>%
  summarise(
    Mean_LOS = round(mean(los, na.rm = TRUE), 2),
    Median_LOS = median(los, na.rm = TRUE),
    SD_LOS = round(sd(los, na.rm = TRUE), 2),
    N = n()
  )

# Bi·ªÉu ƒë·ªì LOS theo nh√≥m tu·ªïi
ggplot(los_by_age, aes(x = age_group, y = Mean_LOS, fill = age_group)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = Mean_LOS - SD_LOS, ymax = Mean_LOS + SD_LOS), width = 0.2) +
  geom_text(aes(label = Mean_LOS), vjust = -0.5) +
  labs(title = "Th·ªùi gian n·∫±m vi·ªán trung b√¨nh theo nh√≥m tu·ªïi",
       x = "Nh√≥m tu·ªïi", y = "LOS trung b√¨nh (ng√†y)") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5))

# Ph√¢n t√≠ch LOS theo gi·ªõi t√≠nh
los_by_gender <- filtered_admission %>%
  group_by(Gender) %>%
  summarise(
    Mean_LOS = round(mean(los, na.rm = TRUE), 2),
    Median_LOS = median(los, na.rm = TRUE),
    SD_LOS = round(sd(los, na.rm = TRUE), 2),
    N = n()
  )

# Boxplot LOS theo gi·ªõi t√≠nh
ggplot(filtered_admission, aes(x = Gender, y = los, fill = Gender)) +
  geom_boxplot(alpha = 0.7) +
  stat_summary(fun = mean, geom = "point", shape = 18, size = 3, color = "red") +
  labs(title = "Ph√¢n b·ªë th·ªùi gian n·∫±m vi·ªán theo gi·ªõi t√≠nh",
       x = "Gi·ªõi t√≠nh", y = "S·ªë ng√†y n·∫±m vi·ªán") +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5))

# Histogram LOS theo gi·ªõi t√≠nh
suppressWarnings(
  ggplot(filtered_admission, aes(x = los, fill = Gender)) +
    geom_histogram(binwidth = 1, alpha = 0.6, position = "identity") +
    scale_fill_manual(values = c("male" = "blue", "female" = "pink")) +
    labs(title = "Ph√¢n b·ªë th·ªùi gian n·∫±m vi·ªán theo gi·ªõi t√≠nh",
         x = "S·ªë ng√†y n·∫±m vi·ªán", y = "S·ªë l∆∞·ª£ng b·ªánh nh√¢n") +
    facet_wrap(~Gender, ncol = 1) +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5))
)

# Ph√¢n t√≠ch k·∫øt h·ª£p nh√≥m tu·ªïi v√† gi·ªõi t√≠nh
los_by_age_gender <- filtered_admission %>%
  group_by(age_group, Gender) %>%
  summarise(
    Mean_LOS = round(mean(los, na.rm = TRUE), 2),
    Median_LOS = median(los, na.rm = TRUE),
    SD_LOS = round(sd(los, na.rm = TRUE), 2),
    N = n()
  )

# Bi·ªÉu ƒë·ªì k·∫øt h·ª£p
suppressWarnings(
  ggplot(los_by_age_gender, aes(x = age_group, y = Mean_LOS, fill = Gender)) +
    geom_bar(stat = "identity", position = position_dodge()) +
    geom_errorbar(aes(ymin = Mean_LOS - SD_LOS, ymax = Mean_LOS + SD_LOS),
                  width = 0.2, position = position_dodge(0.9)) +
    geom_text(aes(label = Mean_LOS), position = position_dodge(width = 0.9), vjust = -0.5) +
    labs(title = "Th·ªùi gian n·∫±m vi·ªán trung b√¨nh theo nh√≥m tu·ªïi v√† gi·ªõi t√≠nh",
         x = "Nh√≥m tu·ªïi", y = "LOS trung b√¨nh (ng√†y)") +
    scale_fill_manual(values = c("male" = "steelblue", "female" = "salmon")) +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5))
)

```


##üîπ 2.3. Ph√¢n lo·∫°i theo m√£ b·ªánh
```{r}
library(dplyr)
library(ggplot2)

# L·ªçc d·ªØ li·ªáu v√† t√≠nh s·ªë l∆∞·ª£ng, ph·∫ßn trƒÉm
icd_stats <- diagnosis_df %>%
  filter(diagnosis %in% c("D500", "D508", "D509")) %>%
  group_by(diagnosis) %>%
  summarise(So_lan_xuat_hien = n()) %>%
  mutate(Percentage = So_lan_xuat_hien / sum(So_lan_xuat_hien) * 100) %>%
  arrange(desc(So_lan_xuat_hien))

# Hi·ªÉn th·ªã b·∫£ng
print(icd_stats)

# V·∫Ω bi·ªÉu ƒë·ªì
ggplot(icd_stats, aes(x = diagnosis, y = So_lan_xuat_hien, fill = diagnosis)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(round(Percentage, 1), "%")), vjust = -0.5) +
  labs(title = "Ph√¢n b·ªë c√°c lo·∫°i thi·∫øu m√°u do thi·∫øu s·∫Øt",
       x = "M√£ ICD10", y = "S·ªë l∆∞·ª£ng") +
  theme_minimal() +
  theme(legend.position = "none")


```
##üîπ 2.4. Ph√¢n t√≠ch ƒëa bi·∫øn
### üîπ 2.4.1. T∆∞∆°ng quan gi·ªØa tu·ªïi v√† th·ªùi gian n·∫±m vi·ªán
```{r}
ggplot(filtered_admission, aes(x = age_years, y = los)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = "T∆∞∆°ng quan gi·ªØa tu·ªïi v√† th·ªùi gian n·∫±m vi·ªán",
       x = "Tu·ªïi", y = "Th·ªùi gian n·∫±m vi·ªán (ng√†y)") +
  theme_minimal()
```
### üîπ 2.4.2. Ph√¢n t√≠ch ANOVA theo gi·ªõi t√≠nh
```{r}
aov_result <- aov(los ~ factor(Gender), data = filtered_admission)
summary(aov_result)
```
## üîπ 2.5. Ph√¢n t√≠ch ngu·ªìn nh·∫≠p vi·ªán
```{r}
# Chuy·ªÉn ƒë·ªïi m√£ ngu·ªìn nh·∫≠p vi·ªán
admsource_mapping <- c(
  "H" = "T·ª± ƒë·∫øn",
  "T" = "Chuy·ªÉn vi·ªán",
  "N" = "C·∫•p c·ª©u",
  "S" = "Ph·∫´u thu·∫≠t"
)

filtered_admission <- filtered_admission %>%
  mutate(admsource = dplyr::recode(admsource, !!!admsource_mapping))


# Th·ªëng k√™ ngu·ªìn nh·∫≠p vi·ªán
admsource_stats <- filtered_admission %>%
  count(admsource) %>%
  mutate(Percentage = n / sum(n) * 100)

# Bi·ªÉu ƒë·ªì ngu·ªìn nh·∫≠p vi·ªán
ggplot(admsource_stats, aes(x = admsource, y = n, fill = admsource)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(round(Percentage, 1), "%")), vjust = -0.5) +
  labs(title = "Ph√¢n b·ªë ngu·ªìn nh·∫≠p vi·ªán",
       x = "Ngu·ªìn nh·∫≠p vi·ªán", y = "S·ªë l∆∞·ª£ng") +
  theme_minimal() +
  theme(legend.position = "none")
```
##üîπ 2.6. Ph√¢n t√≠ch lo·∫°i ƒëi·ªÅu tr·ªã
```{r}
# Chuy·ªÉn ƒë·ªïi m√£ lo·∫°i ƒëi·ªÅu tr·ªã
admtype_mapping <- c(
  "C" = "N·ªôi tr√∫ th√¥ng th∆∞·ªùng",
  "L" = "N·ªôi tr√∫ d√†i ng√†y",
  "O" = "Ngo·∫°i tr√∫",
  "X" = "Kh√°c"
)

filtered_admission <- filtered_admission %>%
  mutate(admtype = dplyr::recode(admtype, !!!admtype_mapping))


# Th·ªëng k√™ lo·∫°i ƒëi·ªÅu tr·ªã
admtype_stats <- filtered_admission %>%
  count(admtype) %>%
  mutate(Percentage = n / sum(n) * 100)

# Bi·ªÉu ƒë·ªì lo·∫°i ƒëi·ªÅu tr·ªã
ggplot(admtype_stats, aes(x = admtype, y = n, fill = admtype)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(round(Percentage, 1), "%")), vjust = -0.5) +
  labs(title = "Ph√¢n b·ªë lo·∫°i ƒëi·ªÅu tr·ªã",
       x = "Lo·∫°i ƒëi·ªÅu tr·ªã", y = "S·ªë l∆∞·ª£ng") +
  theme_minimal() +
  theme(legend.position = "none")
```
##üîπ 2.7. Ph√¢n t√≠ch DRG code
```{r}
# Th·ªëng k√™ DRG code ph·ªï bi·∫øn
drg_stats <- filtered_admission %>%
  count(nat_drg_code) %>%
  arrange(desc(n)) %>%
  head(20)

# Bi·ªÉu ƒë·ªì DRG code ph·ªï bi·∫øn
ggplot(drg_stats, aes(x = reorder(nat_drg_code, n), y = n)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +
  labs(title = "20 DRG code ph·ªï bi·∫øn nh·∫•t",
       x = "DRG Code", y = "S·ªë l∆∞·ª£ng") +
  theme_minimal()
```
# **III. PH√ÇN T√çCH N√ÇNG CAO**

## üîπ 3.1. K·∫øt n·ªëi v·ªõi d·ªØ li·ªáu

Tr∆∞·ªõc khi ph√¢n t√≠ch, ch√∫ng ta c·∫ßn ƒë·ªçc d·ªØ li·ªáu t·ª´ file Excel ƒë√£ l·ªçc ·ªü ph·∫ßn tr∆∞·ªõc.

```{r}
# Load th∆∞ vi·ªán
library(readxl)
library(dplyr)
library(ggplot2)

# ƒê∆∞·ªùng d·∫´n th∆∞ m·ª•c
path <- "D:/Downloads/Data2/"

# ƒê·ªçc d·ªØ li·ªáu ƒë√£ l·ªçc
filtered_admission <- read_excel(paste0(path, "filtered_admission.xlsx"))
filtered_diagnosis <- read_excel(paste0(path, "diagnosis_chi_D500_D508_D509.xlsx"))
```

##üîπ 3.2. Ph√¢n t√≠ch ch·∫©n ƒëo√°n k√®m theo·∫£
```{r}
# L·∫•y t·∫•t c·∫£ ch·∫©n ƒëo√°n c·ªßa b·ªánh nh√¢n thi·∫øu m√°u
all_diag_for_patients <- diagnosis_df %>%
  filter(admission_id %in% matching_ids)

# Lo·∫°i b·ªè ch·∫©n ƒëo√°n thi·∫øu m√°u ƒë·ªÉ ph√¢n t√≠ch b·ªánh k√®m
comorbidity <- all_diag_for_patients %>%
  filter(!diagnosis %in% target_icds)

# Top 20 ch·∫©n ƒëo√°n k√®m theo ph·ªï bi·∫øn
top_comorbidity <- comorbidity %>%
  count(diagnosis) %>%
  arrange(desc(n)) %>%
  head(20)

# Bi·ªÉu ƒë·ªì ch·∫©n ƒëo√°n k√®m theo
ggplot(top_comorbidity, aes(x = reorder(diagnosis, n), y = n)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +
  labs(title = "20 ch·∫©n ƒëo√°n k√®m theo ph·ªï bi·∫øn nh·∫•t",
       x = "M√£ ch·∫©n ƒëo√°n", y = "S·ªë l∆∞·ª£ng") +
  theme_minimal()
```
##üîπ 3.3.Ph√¢n t√≠ch v·ªã tr√≠ ch·∫©n ƒëo√°n thi·∫øu m√°u
```{r}
# Ph√¢n t√≠ch v·ªã tr√≠ ch·∫©n ƒëo√°n thi·∫øu m√°u trong danh s√°ch ch·∫©n ƒëo√°n
position_stats <- filtered_diag %>%
  count(position) %>%
  mutate(Percentage = n / sum(n) * 100)

# Bi·ªÉu ƒë·ªì v·ªã tr√≠ ch·∫©n ƒëo√°n
ggplot(position_stats, aes(x = factor(position), y = n)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_text(aes(label = paste0(round(Percentage, 1), "%")), vjust = -0.5) +
  labs(title = "V·ªã tr√≠ ch·∫©n ƒëo√°n thi·∫øu m√°u trong danh s√°ch ch·∫©n ƒëo√°n",
       x = "V·ªã tr√≠", y = "S·ªë l∆∞·ª£ng") +
  theme_minimal()
```

```{r}
names(filtered_admission)  # xem t√™n c·ªôt
str(filtered_admission[, c("age_years", "los", "weight")])  # ki·ªÉm tra ki·ªÉu d·ªØ li·ªáu
summary(filtered_admission[, c("age_years", "los", "weight")])  # ki·ªÉm tra NA
```


##üîπ3.4. Ph√¢n t√≠ch ma tr·∫≠n t∆∞∆°ng quan
```{r corrplot-figure, echo=FALSE, fig.width=7, fig.height=7}
# C√†i g√≥i n·∫øu c·∫ßn
if (!require("corrplot")) install.packages("corrplot")

# G·ªçi th∆∞ vi·ªán
library(dplyr)
library(corrplot)

# X·ª≠ l√Ω d·ªØ li·ªáu
corr_data <- filtered_admission %>%
  select(age_years, los, weight) %>%
  mutate(
    weight = na_if(weight, 9999),  # Chuy·ªÉn 9999 th√†nh NA
    across(everything(), as.numeric)
  ) %>%
  select(where(~ !all(is.na(.))))  # Lo·∫°i c·ªôt to√†n NA

# Ki·ªÉm tra d·ªØ li·ªáu h·ª£p l·ªá
if (ncol(corr_data) < 2) stop("‚ùå Kh√¥ng ƒë·ªß bi·∫øn ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì t∆∞∆°ng quan.")
if (nrow(corr_data) == 0) stop("‚ùå Kh√¥ng c√≥ d√≤ng d·ªØ li·ªáu h·ª£p l·ªá.")
if (all(is.na(cor(corr_data, use = "complete.obs")))) stop("‚ùå Ma tr·∫≠n t∆∞∆°ng quan ch·ª©a to√†n NA.")

# T√≠nh t∆∞∆°ng quan
cor_matrix <- cor(corr_data, use = "complete.obs")

# V·∫Ω bi·ªÉu ƒë·ªì
corrplot(cor_matrix,
         method = "color",
         type = "upper",
         tl.col = "black",
         tl.srt = 45,
         addCoef.col = "black",
         number.cex = 0.7,
         mar = c(0, 0, 1, 0),
         title = "üîπ Ma tr·∫≠n t∆∞∆°ng quan gi·ªØa tu·ªïi, th·ªùi gian n·∫±m vi·ªán v√† c√¢n n·∫∑ng")

```
##üîπ 3.5. Ph√¢n t√≠ch theo nh√≥m nguy c∆° cao
```{r}
# X√°c ƒë·ªãnh nh√≥m nguy c∆° cao (tu·ªïi > 65 ho·∫∑c LOS > 7 ng√†y)
filtered_admission <- filtered_admission %>%
  mutate(high_risk = ifelse(age_years > 65 | los > 7, "Cao", "Th·∫•p"))

# Th·ªëng k√™ nh√≥m nguy c∆°
risk_stats <- filtered_admission %>%
  count(high_risk) %>%
  mutate(Percentage = n / sum(n) * 100)

# Bi·ªÉu ƒë·ªì nh√≥m nguy c∆°
ggplot(risk_stats, aes(x = high_risk, y = n, fill = high_risk)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(round(Percentage, 1), "%")), vjust = -0.5) +
  labs(title = "Ph√¢n b·ªë b·ªánh nh√¢n theo nh√≥m nguy c∆°",
       x = "Nh√≥m nguy c∆°", y = "S·ªë l∆∞·ª£ng") +
  theme_minimal() +
  theme(legend.position = "none")
```
##üîπ3.6. X√¢y d·ª±ng m√¥ h√¨nh d·ª± ƒëo√°n th·ªùi gian n·∫±m vi·ªán
```{r}
# C√†i v√† g·ªçi th∆∞ vi·ªán
if (!require("caret")) install.packages("caret")
if (!require("ggplot2")) install.packages("ggplot2")
library(caret)
library(ggplot2)
library(dplyr)

# Chu·∫©n b·ªã d·ªØ li·ªáu cho m√¥ h√¨nh
model_data <- filtered_admission %>%
  select(age_years, Gender, los, admsource, admtype) %>%
  mutate_if(is.character, as.factor)

model_data <- na.omit(model_data)

# Chia train/test
set.seed(123)
train_index <- createDataPartition(model_data$los, p = 0.8, list = FALSE)
train_data <- model_data[train_index, ]
test_data <- model_data[-train_index, ]

# Hu·∫•n luy·ªán m√¥ h√¨nh h·ªìi quy
model <- train(
  los ~ .,
  data = train_data,
  method = "lm",
  trControl = trainControl(method = "cv", number = 5)
)

# D·ª± ƒëo√°n
predictions <- predict(model, newdata = test_data)
rmse <- sqrt(mean((predictions - test_data$los)^2))

cat("üîç Hi·ªáu su·∫•t m√¥ h√¨nh d·ª± ƒëo√°n LOS:\n")
cat("üìâ RMSE:", round(rmse, 2), "\n")

# Bi·∫øn ƒë√°nh gi√°
eval_df <- data.frame(
  Actual = test_data$los,
  Predicted = predictions,
  Residual = test_data$los - predictions
)

# 1Ô∏è‚É£ Bi·ªÉu ƒë·ªì scatter: Predicted vs Actual
ggplot(eval_df, aes(x = Actual, y = Predicted)) +
  geom_point(color = "steelblue", alpha = 0.6) +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  labs(title = "D·ª± ƒëo√°n LOS vs. Gi√° tr·ªã th·ª±c t·∫ø",
       x = "LOS th·ª±c t·∫ø",
       y = "LOS d·ª± ƒëo√°n") +
  theme_minimal()

# 2Ô∏è‚É£ Bi·ªÉu ƒë·ªì residuals
ggplot(eval_df, aes(x = Predicted, y = Residual)) +
  geom_point(color = "darkorange", alpha = 0.6) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray40") +
  labs(title = "Ph√¢n t√≠ch sai s·ªë d·ª± ƒëo√°n (residuals)",
       x = "LOS d·ª± ƒëo√°n",
       y = "Sai s·ªë (Residual)") +
  theme_minimal()
```

##üîπ 3.7.Ki·ªÉm ƒë·ªãnh T-test: Th·ªùi gian n·∫±m vi·ªán gi·ªØa nam v√† n·ªØ
```{r ttest-los-gender, message=FALSE, warning=FALSE}
# Chuy·ªÉn gi·ªõi t√≠nh v·ªÅ d·∫°ng s·ªë n·∫øu ch∆∞a (Nam = 1, N·ªØ = 2)
# filtered_admission$Gender <- ifelse(filtered_admission$Gender == "Nam", 1, 2)

# T·∫°o 2 nh√≥m LOS theo gi·ªõi t√≠nh
male_los <- filtered_admission %>% filter(Gender == 1) %>% pull(los)
female_los <- filtered_admission %>% filter(Gender == 2) %>% pull(los)

# Th·ª±c hi·ªán ki·ªÉm ƒë·ªãnh t-test ƒë·ªôc l·∫≠p
ttest_result <- t.test(male_los, female_los)

# In k·∫øt qu·∫£
ttest_result
```
```{r}
cat("**üéØ K·∫øt lu·∫≠n ki·ªÉm ƒë·ªãnh T-test:**\n\n")
cat("- T-statistic: ", round(ttest_result$statistic, 3), "\n")
cat("- P-value: ", round(ttest_result$p.value, 4), "\n\n")

if (ttest_result$p.value < 0.05) {
  cat("‚úÖ C√≥ s·ª± kh√°c bi·ªát c√≥ √Ω nghƒ©a th·ªëng k√™ gi·ªØa th·ªùi gian n·∫±m vi·ªán c·ªßa nam v√† n·ªØ.")
} else {
  cat("‚ÑπÔ∏è Kh√¥ng c√≥ s·ª± kh√°c bi·ªát c√≥ √Ω nghƒ©a th·ªëng k√™ gi·ªØa th·ªùi gian n·∫±m vi·ªán c·ªßa nam v√† n·ªØ.")
}
```

