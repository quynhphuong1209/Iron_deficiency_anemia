# -*- coding: utf-8 -*-
"""M√£ ho√° b·ªánh t·∫≠t D50_ Thi·∫øu m√°u do thi·∫øu s·∫Øt.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1YmVxcixzrPQjt-Re5xTzfcG4mEKqk1mj

# **I. ƒê·ªåC V√Ä TI·ªÄN X·ª¨ L√ù D·ªÆ LI·ªÜU THEO CH·ª¶ ƒê·ªÄ D50: THI·∫æU M√ÅU DO THI·∫æU S·∫ÆT(G·ªíM C√ÅC M√É B·ªÜNH NH√ÇN: D500, D508 v√† D509)**

# üîπ 1.1. K·∫øt n·ªëi v·ªõi Google Drive

Tr∆∞·ªõc khi l√†m vi·ªác v·ªõi d·ªØ li·ªáu l∆∞u tr√™n Google Drive, b·∫°n c·∫ßn k·∫øt n·ªëi Drive v·ªõi Google Colab ƒë·ªÉ c√≥ th·ªÉ truy c·∫≠p file. L·ªánh drive.mount('/content/drive') gi√∫p b·∫°n g·∫Øn Drive c√° nh√¢n v√†o m√¥i tr∆∞·ªùng l√†m vi·ªác Colab.
"""

from google.colab import drive
drive.mount('/content/drive')

"""# üîπ 1.2. ƒê·ªçc d·ªØ li·ªáu t·ª´ file Excel

S·ª≠ d·ª•ng th∆∞ vi·ªán pandas, b·∫°n ƒë·ªçc hai b·∫£ng d·ªØ li·ªáu t·ª´ th∆∞ m·ª•c Google Drive:


*   admission.xlsx: ch·ª©a th√¥ng tin nh·∫≠p vi·ªán c·ªßa b·ªánh nh√¢n
*   diagnosis.xlsx: ch·ª©a m√£ ICD10 ch·∫©n ƒëo√°n cho m·ªói b·ªánh nh√¢n


"""

# Import th∆∞ vi·ªán
import pandas as pd

# ƒê∆∞·ªùng d·∫´n th∆∞ m·ª•c trong Google Drive
path = '/content/drive/Shared drives/M√£ ho√° b·ªánh t·∫≠t_Nh√≥m 5/Data2/'

# ƒê·ªçc d·ªØ li·ªáu t·ª´ Drive
admission_df = pd.read_excel(path + 'admission.xlsx')
diagnosis_df = pd.read_excel(path + 'diagnosis.xlsx')

# C·∫•u h√¨nh ƒë·ªÉ hi·ªÉn th·ªã to√†n b·ªô b·∫£ng (kh√¥ng gi·ªõi h·∫°n s·ªë d√≤ng/c·ªôt)
pd.set_option('display.max_rows', None)
pd.set_option('display.max_columns', None)
pd.set_option('display.width', None)
pd.set_option('display.max_colwidth', None)

# Hi·ªÉn th·ªã to√†n b·ªô b·∫£ng admission
print("üìÑ TO√ÄN B·ªò B·∫¢NG ADMISSION:")
display(admission_df.sample(20))

# Hi·ªÉn th·ªã to√†n b·ªô b·∫£ng diagnosis
print("\nüìÑ TO√ÄN B·ªò B·∫¢NG DIAGNOSIS:")
display(diagnosis_df.sample(20))

"""# üîπ  1.3. L·ªçc c√°c ch·∫©n ƒëo√°n theo m√£ ICD10

Nh√≥m em t·∫≠p trung ph√¢n t√≠ch c√°c b·ªánh nh√¢n c√≥ m√£ ch·∫©n ƒëo√°n:

- D500: Thi·∫øu m√°u thi·∫øu s·∫Øt do m·∫•t m√°u m·∫°n t√≠nh

- D508: Thi·∫øu m√°u thi·∫øu s·∫Øt kh√°c

- D509: Thi·∫øu m√°u thi·∫øu s·∫Øt kh√¥ng x√°c ƒë·ªãnh

L·ªçc c√°c d√≤ng trong b·∫£ng diagnosis c√≥ m√£ ICD thu·ªôc danh s√°ch tr√™n.
"""

# L·ªçc c√°c m√£ ICD10 l√† D500, D508, D509
target_icds = ['D500', 'D508', 'D509']
filtered_diag = diagnosis_df[diagnosis_df['diagnosis'].isin(target_icds)]

"""# üîπ 1.4. L·∫•y danh s√°ch c√°c admission_id t∆∞∆°ng ·ª©ng

T·ª´ b·∫£ng diagnosis ƒë√£ l·ªçc, ch√∫ng t√¥i tr√≠ch ra t·∫•t c·∫£ c√°c admission_id li√™n quan ƒë·∫øn c√°c b·ªánh nh√¢n mang m√£ D500, D508, D509.
"""

# L·∫•y danh s√°ch ID ph√π h·ª£p
matching_ids = filtered_diag['admission_id'].unique()

"""# üîπ 1.5. L·ªçc b·∫£ng Admission v√† Diagnosis t∆∞∆°ng ·ª©ng

T·ª´ b·∫£ng `admission.xlsx`, ch·ªâ gi·ªØ l·∫°i nh·ªØng d√≤ng c√≥ `admission_id` t∆∞∆°ng ·ª©ng v·ªõi c√°c b·ªánh nh√¢n ƒë√£ ƒë∆∞·ª£c l·ªçc trong b·∫£ng `diagnosis` ·ªü b∆∞·ªõc tr∆∞·ªõc ‚Äî t·ª©c l√† c√°c b·ªánh nh√¢n c√≥ m√£ b·ªánh thu·ªôc nh√≥m thi·∫øu m√°u do thi·∫øu s·∫Øt (D500, D508, D509). Vi·ªác n√†y gi√∫p ƒë·∫£m b·∫£o r·∫±ng ch·ªâ nh·ªØng l∆∞·ª£t nh·∫≠p vi·ªán li√™n quan ƒë·∫øn v·∫•n ƒë·ªÅ s·ª©c kh·ªèe ƒëang ƒë∆∞·ª£c nghi√™n c·ª©u m·ªõi ƒë∆∞·ª£c ƒë∆∞a v√†o ph√¢n t√≠ch chuy√™n s√¢u ti·∫øp theo.
"""

# L·ªçc admission t∆∞∆°ng ·ª©ng v·ªõi c√°c ID
filtered_admission = admission_df[admission_df['admission_id'].isin(matching_ids)]

# üîç L·ªçc c√°c d√≤ng c√≥ Diagnosis b·∫Øt ƒë·∫ßu b·∫±ng D500, D508, ho·∫∑c D509
filtered_df = diagnosis_df[diagnosis_df['diagnosis'].str.match(r'^D500|^D508|^D509', na=False)]

"""# üîπ 1.6. Xu·∫•t file Excel k·∫øt qu·∫£

D·ªØ li·ªáu sau khi l·ªçc ƒë∆∞·ª£c l∆∞u v√†o file m·ªõi: `filtered_admission.xlsx` v√† `diagnosis_chi_D500_D508_D509`

"""

# Xu·∫•t file k·∫øt qu·∫£ v√†o l·∫°i Google Drive
filtered_admission.to_excel(path + 'filtered_admission.xlsx', index=False)
print("‚úÖ File filtered_admission.xlsx ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o Google Drive.")

# Xu·∫•t file v√†o Google Drive
output_path = path + "diagnosis_chi_D500_D508_D509.xlsx"
filtered_df.to_excel(output_path, index=False)

print("‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng file:", output_path)

"""# üîπ 1.7. Ki·ªÉm tra ƒë·ªô nh·∫•t qu√°n d·ªØ li·ªáu

Nh√≥m ti·∫øn h√†nh ki·ªÉm tra t√≠nh nh·∫•t qu√°n c·ªßa d·ªØ li·ªáu b·∫±ng c√°ch so s√°nh c√°c m√£ ƒë·ªãnh danh gi·ªØa c√°c b·∫£ng g·ªëc v√† b·∫£ng ƒë√£ l·ªçc, c·ª• th·ªÉ:

‚úÖ ƒê·ªëi v·ªõi b·∫£ng `admission`:

- So s√°nh danh s√°ch `admission_id` gi·ªØa b·∫£ng g·ªëc v√† b·∫£ng ƒë√£ l·ªçc.

- ƒê·∫£m b·∫£o r·∫±ng t·∫•t c·∫£ c√°c d√≤ng trong b·∫£ng l·ªçc ƒë·ªÅu th·ª±c s·ª± t·ªìn t·∫°i trong b·∫£ng g·ªëc v√† kh√¥ng c√≥ d·ªØ li·ªáu b·ªã thi·∫øu, tr√πng ho·∫∑c sai l·ªách.

- N·∫øu ph√°t hi·ªán `admission_id` kh√¥ng kh·ªõp, h·ªá th·ªëng s·∫Ω in ra ƒë·ªÉ ng∆∞·ªùi d√πng ki·ªÉm tra th·ªß c√¥ng.

‚úÖ ƒê·ªëi v·ªõi b·∫£ng `diagnosis`:

- Ki·ªÉm tra t√≠nh nh·∫•t qu√°n c·ªßa c·ªôt Diagnosis gi·ªØa b·∫£ng diagnosis ƒë√£ l·ªçc v√† b·∫£ng g·ªëc.

- ƒê·∫£m b·∫£o r·∫±ng t·∫•t c·∫£ c√°c d√≤ng trong b·∫£ng l·ªçc ƒë·ªÅu ch·ª©a c√°c ch·∫©n ƒëo√°n th·ª±c s·ª± c√≥ trong b·∫£ng g·ªëc.

- N·∫øu ph√°t hi·ªán c√≥ d√≤ng ch·∫©n ƒëo√°n b·ªã sai m√£ ho·∫∑c kh√¥ng t·ªìn t·∫°i trong d·ªØ li·ªáu ban ƒë·∫ßu, h·ªá th·ªëng s·∫Ω in ra danh s√°ch Diagnosis kh√¥ng kh·ªõp ƒë·ªÉ ki·ªÉm tra l·∫°i.
"""

# Ki·ªÉm tra admission_id
original_ids = set(admission_df['admission_id'])
filtered_ids = set(filtered_admission['admission_id'])

if filtered_ids.issubset(original_ids):
    print("‚úÖ T·∫•t c·∫£ admission_id trong file l·ªçc ƒë·ªÅu tr√πng kh·ªõp v·ªõi file g·ªëc.")
else:
    missing_ids = filtered_ids - original_ids
    print("‚ö†Ô∏è M·ªôt s·ªë admission_id kh√¥ng t√¨m th·∫•y trong file g·ªëc:")
    print(missing_ids)

# Ki·ªÉm tra ch·∫©n ƒëo√°n (Diagnosis)
original_diag_ids = set(diagnosis_df['diagnosis'])
filtered_diag_ids = set(filtered_df['diagnosis'])

if filtered_diag_ids.issubset(original_diag_ids):
    print("‚úÖ T·∫•t c·∫£ ID trong file diagnosis ƒë√£ l·ªçc ƒë·ªÅu tr√πng kh·ªõp v·ªõi file g·ªëc.")
else:
    missing_diag_ids = filtered_diag_ids - original_diag_ids
    print("‚ö†Ô∏è M·ªôt s·ªë ID kh√¥ng t√¨m th·∫•y trong file diagnosis g·ªëc:")
    print(missing_diag_ids)

"""# üîπ 1.8. Hi·ªÉn th·ªã b·∫£ng admission v√† diagnosis"""

# Hi·ªÉn th·ªã b·∫£ng admission sau khi l·ªçc
print("\nüìã D·ªØ li·ªáu admission ƒë√£ l·ªçc:")
display(filtered_admission)

# Hi·ªÉn th·ªã b·∫£ng diagnosis sau khi l·ªçc
print("\nüìã D·ªØ li·ªáu diagnosis ƒë√£ l·ªçc:")
display(filtered_df)

"""# **II. TH·ªêNG K√ä T·ªîNG QUAN TO√ÄN B·ªò D·ªÆ LI·ªÜU**

# üîπ 2.1. Ki·ªÉm tra c√°c c·ªôt d·ªØ li·ªáu sau khi g·ªôp

Sau khi g·ªôp 3 b·∫£ng `diagnosis_chi_D500_D508_D509.xlsx`, `filtered_admission.xlsx`, v√† `ICD10`, ta ki·ªÉm tra danh s√°ch c√°c c·ªôt hi·ªán c√≥ trong b·∫£ng `merged_df`. ƒêi·ªÅu n√†y gi√∫p n·∫Øm ƒë∆∞·ª£c c·∫•u tr√∫c d·ªØ li·ªáu sau ti·ªÅn x·ª≠ l√Ω, ƒë·ªÉ x√°c ƒë·ªãnh c√°c tr∆∞·ªùng c·∫ßn thi·∫øt cho c√°c b∆∞·ªõc ph√¢n t√≠ch sau.
"""

import pandas as pd
from IPython.display import display

# ƒê∆∞·ªùng d·∫´n th∆∞ m·ª•c trong Google Drive
path = '/content/drive/Shared drives/M√£ ho√° b·ªánh t·∫≠t_Nh√≥m 5/Data2/'
# ƒê·ªçc c√°c file Excel
diagnosis_df = pd.read_excel(path+ "diagnosis_chi_D500_D508_D509.xlsx")
admission_df = pd.read_excel(path+"filtered_admission.xlsx")
icd10_df = pd.read_excel(path+"ICD10.xlsx")


# C·∫•u h√¨nh hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß
pd.set_option("display.max_columns", None)      # Hi·ªán t·∫•t c·∫£ c·ªôt
pd.set_option("display.width", None)            # Kh√¥ng gi·ªõi h·∫°n ƒë·ªô r·ªông
pd.set_option("display.max_rows", None)         # ‚ö†Ô∏è Hi·ªán to√†n b·ªô d√≤ng (c·∫©n th·∫≠n n·∫øu >1000 d√≤ng)
pd.set_option("display.max_colwidth", None)     # Kh√¥ng c·∫Øt n·ªôi dung √¥

# G·ªôp diagnosis v√† admission
merged_df = diagnosis_df.merge(admission_df, on="admission_id", how="inner")
print(f"\n‚úÖ S·ªë d√≤ng sau khi g·ªôp DIAGNOSIS v·ªõi ADMISSION: {len(merged_df)}")
display(merged_df)  # üëâ Hi·ªÉn th·ªã to√†n b·ªô b·∫£ng

# G·ªôp th√™m m√¥ t·∫£ b·ªánh ICD10
merged_df = merged_df.merge(icd10_df, left_on="diagnosis", right_on="code", how="left")
print(f"\n‚úÖ S·ªë d√≤ng sau khi g·ªôp th√™m ICD10: {len(merged_df)}")
display(merged_df)  # üëâ Hi·ªÉn th·ªã to√†n b·ªô b·∫£ng

"""# üîπ 2.2. Ph√¢n nh√≥m tu·ªïi
ƒê·ªÉ thu·∫≠n ti·ªán cho vi·ªác ph√¢n t√≠ch, tu·ªïi `age_years` c·ªßa b·ªánh nh√¢n ƒë∆∞·ª£c ph√¢n chia th√†nh c√°c nh√≥m tu·ªïi nh∆∞ sau:

- 0‚Äì9 tu·ªïi

- 10‚Äì19 tu·ªïi

- 20‚Äì29 tu·ªïi

- 30‚Äì39 tu·ªïi

- 40‚Äì49 tu·ªïi

- 50‚Äì59 tu·ªïi

- 60 tu·ªïi tr·ªü l√™n

Vi·ªác ph√¢n nh√≥m n√†y gi√∫p d·ªÖ d√†ng th·ªëng k√™ v√† so s√°nh c√°c ƒë·∫∑c ƒëi·ªÉm y t·∫ø gi·ªØa c√°c nh√≥m tu·ªïi kh√°c nhau.
"""

# Ph√¢n nh√≥m tu·ªïi
def get_age_group(age):
    if age < 10:
        return "0-9"
    elif age < 20:
        return "10-19"
    elif age < 30:
        return "20-29"
    elif age < 40:
        return "30-39"
    elif age < 50:
        return "40-49"
    elif age < 60:
        return "50-59"
    else:
        return "60+"

merged_df["age_group"] = merged_df["age_years"].apply(get_age_group)

# Hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß
pd.set_option("display.max_columns", None)
pd.set_option("display.max_rows", None)
pd.set_option("display.width", None)

"""# üîπ 2.3. Hi·ªÉn th·ªã 5 d√≤ng d·ªØ li·ªáu ƒë·∫ßu ti√™n
Xem tr∆∞·ªõc 5 d√≤ng ƒë·∫ßu ti√™n c·ªßa b·∫£ng `merged_df` ƒë·ªÉ ki·ªÉm tra tr·ª±c quan xem d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c g·ªôp v√† x·ª≠ l√Ω ƒë√∫ng ch∆∞a (bao g·ªìm th√¥ng tin ch·∫©n ƒëo√°n, tu·ªïi, gi·ªõi t√≠nh, m√¥ t·∫£ b·ªánh...).
"""

# Hi·ªÉn th·ªã 5 d√≤ng ƒë·∫ßu
print("\nüìå D·ªÆ LI·ªÜU M·∫™U:")
display(merged_df.head())

"""# üîπ 2.4. Th·ªëng k√™ ph√¢n b·ªë theo nh√≥m tu·ªïi
S·ª≠ d·ª•ng bi·∫øn `age_group` ƒë√£ t·∫°o, ta th·ªëng k√™ s·ªë l∆∞·ª£ng b·ªánh nh√¢n trong m·ªói nh√≥m tu·ªïi. Th·ªëng k√™ n√†y gi√∫p nh·∫≠n di·ªán nh√≥m tu·ªïi n√†o c√≥ t·ªâ l·ªá m·∫Øc b·ªánh cao h∆°n, t·ª´ ƒë√≥ h·ªó tr·ª£ ƒë·ªãnh h∆∞·ªõng ph√¢n t√≠ch chuy√™n s√¢u ·ªü c√°c b∆∞·ªõc sau.
"""

import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from IPython.display import display, HTML

print("\n3. PH√ÇN B·ªê ƒê·ªò TU·ªîI")

# T·∫°o nh√≥m tu·ªïi
admission_df['age_group'] = pd.cut(admission_df['age_years'],
                                  bins=[0, 10, 20, 30, 40, 50, 60, 70],
                                  labels=['0-9', '10-19', '20-29', '30-39', '40-49', '50-59', '60+'])

# T·∫°o b·∫£ng ph√¢n b·ªë ƒë·ªô tu·ªïi
age_dist = admission_df['age_group'].value_counts().sort_index()
age_table = pd.DataFrame({
    'Nh√≥m tu·ªïi': age_dist.index,
    'S·ªë l∆∞·ª£ng b·ªánh nh√¢n': age_dist.values,
    'T·ª∑ l·ªá (%)': (age_dist.values / age_dist.values.sum() * 100).round(2)
})

# Hi·ªÉn th·ªã b·∫£ng d∆∞·ªõi d·∫°ng ƒë·∫πp
display(HTML("<h4>B·∫£ng ph√¢n b·ªë b·ªánh nh√¢n theo nh√≥m tu·ªïi</h4>"))
display(age_table)

# Bi·ªÉu ƒë·ªì n√¢ng c·∫•p: M√†u gradient + th√™m nh√£n s·ªë
plt.figure(figsize=(10, 6))
barplot = sns.barplot(data=age_table, x='Nh√≥m tu·ªïi', y='S·ªë l∆∞·ª£ng b·ªánh nh√¢n', palette='viridis')

# Th√™m nh√£n tr√™n ƒë·∫ßu c·ªôt
for i, value in enumerate(age_table['S·ªë l∆∞·ª£ng b·ªánh nh√¢n']):
    barplot.text(i, value + 1, str(value), ha='center', va='bottom', fontsize=10)

plt.title('Ph√¢n b·ªë ƒë·ªô tu·ªïi b·ªánh nh√¢n thi·∫øu m√°u do thi·∫øu s·∫Øt')
plt.xlabel('Nh√≥m tu·ªïi')
plt.ylabel('S·ªë l∆∞·ª£ng b·ªánh nh√¢n')
plt.tight_layout()
plt.show()

"""# üîπ 2.5. Th·ªëng k√™ ph√¢n b·ªë theo gi·ªõi t√≠nh
Ph√¢n t√≠ch ph√¢n b·ªë b·ªánh nh√¢n theo gi·ªõi t√≠nh (v√≠ d·ª•: nam (1), n·ªØ (2)) gi√∫p ƒë√°nh gi√° xem c√≥ s·ª± kh√°c bi·ªát gi·ªõi trong b·ªánh l√Ω thi·∫øu m√°u do thi·∫øu s·∫Øt hay kh√¥ng. ƒê√¢y l√† m·ªôt ch·ªâ b√°o quan tr·ªçng trong y t·∫ø c√¥ng c·ªông.
"""

# Th·ªëng k√™ theo gi·ªõi t√≠nh
print("\nüìä PH√ÇN B·ªê GI·ªöI T√çNH:")
gender_counts = merged_df["Gender"].value_counts().reset_index()
gender_counts.columns = ["Gender", "Count"]
display(gender_counts)

gender_dist = gender_counts.set_index("Gender")["Count"]

plt.figure(figsize=(8, 6))
gender_dist.plot(kind='pie', autopct='%1.1f%%', colors=['lightblue', 'pink'])
plt.title('Ph√¢n b·ªë gi·ªõi t√≠nh b·ªánh nh√¢n thi·∫øu m√°u do thi·∫øu s·∫Øt')
plt.ylabel('')
plt.show()

"""# üîπ 2.6. Th·ªëng k√™ 5 ch·∫©n ƒëo√°n ph·ªï bi·∫øn nh·∫•t
D·ª±a v√†o c·ªôt m√¥ t·∫£ ch·∫©n ƒëo√°n `description`, th·ªëng k√™ 5 ch·∫©n ƒëo√°n ICD10 xu·∫•t hi·ªán nhi·ªÅu nh·∫•t trong to√†n b·ªô d·ªØ li·ªáu. K·∫øt qu·∫£ n√†y cho th·∫•y nh·ªØng d·∫°ng thi·∫øu m√°u thi·∫øu s·∫Øt n√†o ƒëang ph·ªï bi·∫øn nh·∫•t trong c·ªông ƒë·ªìng b·ªánh nh√¢n ƒë∆∞·ª£c kh·∫£o s√°t.
"""

# ƒê·∫øm s·ªë l∆∞·ª£ng t·ª´ng lo·∫°i thi·∫øu m√°u
diagnosis_dist = diagnosis_df['diagnosis'].value_counts()
diagnosis_table = pd.DataFrame({
    'M√£ ch·∫©n ƒëo√°n': diagnosis_dist.index,
    'S·ªë l∆∞·ª£ng b·ªánh nh√¢n': diagnosis_dist.values,
    'T·ª∑ l·ªá (%)': (diagnosis_dist.values / diagnosis_dist.values.sum() * 100).round(2)
})

# Hi·ªÉn th·ªã b·∫£ng d∆∞·ªõi d·∫°ng HTML
display(HTML("<h4>B·∫£ng ph√¢n b·ªë lo·∫°i thi·∫øu m√°u do thi·∫øu s·∫Øt</h4>"))
display(diagnosis_table)

# Bi·ªÉu ƒë·ªì ƒë·∫πp h∆°n
plt.figure(figsize=(8, 6))
bar = sns.barplot(data=diagnosis_table, x='M√£ ch·∫©n ƒëo√°n', y='S·ªë l∆∞·ª£ng b·ªánh nh√¢n',
                  palette='Set2')

# Th√™m nh√£n s·ªë
for i, value in enumerate(diagnosis_table['S·ªë l∆∞·ª£ng b·ªánh nh√¢n']):
    bar.text(i, value + 0.5, str(value), ha='center', va='bottom', fontsize=10)

plt.title('Ph√¢n b·ªë lo·∫°i thi·∫øu m√°u do thi·∫øu s·∫Øt')
plt.xlabel('M√£ ch·∫©n ƒëo√°n')
plt.ylabel('S·ªë l∆∞·ª£ng b·ªánh nh√¢n')
plt.tight_layout()
plt.show()

"""# **III. PH√ÇN T√çCH D·ªÆ LI·ªÜU B·ªÜNH NH√ÇN THI·∫æU M√ÅU DO THI·∫æU S·∫ÆT (D50)**

# üîπ 3.1.  Th·ªëng k√™ v√† tr·ª±c quan h√≥a th·ªùi gian n·∫±m vi·ªán (LOS)
"""

import matplotlib.pyplot as plt
import os
from IPython.display import HTML, display
import base64
import seaborn as sns
import pandas as pd

# Hi·ªÉn th·ªã b·∫£ng th·ªëng k√™ m√¥ t·∫£
los_stats = admission_df['los'].describe().round(2).to_frame(name="Gi√° tr·ªã th·ªëng k√™")
display(HTML("<h4>üìã Th·ªëng k√™ m√¥ t·∫£ th·ªùi gian n·∫±m vi·ªán (ng√†y)</h4>"))
display(los_stats.style.set_table_attributes("style='display:inline'").set_caption("Ngu·ªìn: admission_df"))

# T·∫°o th∆∞ m·ª•c l∆∞u ·∫£nh
if not os.path.exists("charts_los"):
    os.makedirs("charts_los")

# V·∫Ω Boxplot
fig1, ax1 = plt.subplots(figsize=(8, 5))
sns.boxplot(x=admission_df['los'], ax=ax1, color='lightcoral')
ax1.set_title('Boxplot th·ªùi gian n·∫±m vi·ªán')  # üëà B·ªé emoji
ax1.set_xlabel('S·ªë ng√†y n·∫±m vi·ªán')
plt.tight_layout()
boxplot_path = "charts_los/boxplot_los.png"
plt.savefig(boxplot_path, bbox_inches='tight')
plt.close(fig1)

# V·∫Ω Histogram
fig2, ax2 = plt.subplots(figsize=(8, 5))
sns.histplot(admission_df['los'], bins=30, kde=True, color='steelblue', ax=ax2)
ax2.set_title('Histogram th·ªùi gian n·∫±m vi·ªán')  # üëà B·ªé emoji
ax2.set_xlabel('S·ªë ng√†y n·∫±m vi·ªán')
ax2.set_ylabel('S·ªë l∆∞·ª£ng b·ªánh nh√¢n')
plt.tight_layout()
hist_path = "charts_los/histogram_los.png"
plt.savefig(hist_path, bbox_inches='tight')
plt.close(fig2)

# H√†m t·∫°o ·∫£nh HTML
def img_tag_from_path(path):
    with open(path, "rb") as f:
        data = base64.b64encode(f.read()).decode("utf-8")
    return f'<img src="data:image/png;base64,{data}" style="margin-right: 40px; border:1px solid #ccc; width: 700px"/>'

# Hi·ªÉn th·ªã ·∫£nh song song
html_code = f'''
<h4>üñºÔ∏è Bi·ªÉu ƒë·ªì ph√¢n b·ªë th·ªùi gian n·∫±m vi·ªán</h4>
<div style="display: flex; overflow-x: auto;">
    {img_tag_from_path(boxplot_path)}
    {img_tag_from_path(hist_path)}
</div>
'''
display(HTML(html_code))

"""# üîπ 3.2. Tr·ª±c quan h√≥a th·ªùi gian n·∫±m vi·ªán theo gi·ªõi t√≠nh v√† nh√≥m tu·ªïi"""

import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import os
import base64
from IPython.display import display, HTML

# --- T·∫†O TH∆Ø M·ª§C CH·ª®A ·∫¢NH ---
if not os.path.exists("charts"):
    os.makedirs("charts")

# --- TI·ªÄN X·ª¨ L√ù ---
admission_df['los'] = pd.to_numeric(admission_df['los'], errors='coerce')
admission_df = admission_df.dropna(subset=['los'])

# N·∫øu Gender c√≥ gi√° tr·ªã l√† s·ªë (1,2), th√¨ map sang chu·ªói Nam/N·ªØ
if 'Gender' in admission_df.columns:
    unique_vals = admission_df['Gender'].dropna().unique()
    if all(val in [1, 2] for val in unique_vals):
        admission_df['Gender'] = admission_df['Gender'].map({1: 'Nam', 2: 'N·ªØ'})


# --- KI·ªÇM TRA C·ªòT GENDER ---
if 'Gender' in admission_df.columns:
    print("üéØ C√°c gi√° tr·ªã trong Gender:", admission_df['Gender'].unique())
    print("üßÆ S·ªë l∆∞·ª£ng m·ªói gi·ªõi t√≠nh:\n", admission_df['Gender'].value_counts())


# --- KI·ªÇM TRA C·ªú ---
has_gender = 'Gender' in admission_df.columns and admission_df['Gender'].dropna().nunique() >= 2
has_age_group = 'age_group' in admission_df.columns and admission_df['age_group'].dropna().nunique() > 0

if not has_gender:
    print("‚ö†Ô∏è Kh√¥ng ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì theo gi·ªõi t√≠nh.")
if not has_age_group:
    print("‚ö†Ô∏è Kh√¥ng ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì theo nh√≥m tu·ªïi.")

image_tags = []

# --- HISTOGRAM THEO GI·ªöI T√çNH ---
if has_gender:
    plt.figure(figsize=(10, 5))
    los_counts = admission_df.groupby('Gender')['los'].nunique()
    can_use_kde = all(los_counts >= 2)
    sns.histplot(data=admission_df, x='los', hue='Gender', bins=30, kde=can_use_kde, palette='Set2', element='step')
    plt.title('üìä Ph√¢n ph·ªëi th·ªùi gian n·∫±m vi·ªán theo gi·ªõi t√≠nh')
    plt.xlabel('S·ªë ng√†y')
    plt.ylabel('S·ªë b·ªánh nh√¢n')
    plt.grid(True)
    filename = "charts/hist_gender.png"
    plt.savefig(filename, bbox_inches='tight')
    plt.close()
    print("‚úÖ ƒê√£ l∆∞u:", filename)

    with open(filename, "rb") as f:
        img_data = base64.b64encode(f.read()).decode("utf-8")
        img_tag = f'<img src="data:image/png;base64,{img_data}" style="margin-right:20px; width:700px; border:1px solid #ccc"/>'
        image_tags.append(img_tag)

# --- BOXPLOT THEO GI·ªöI T√çNH ---
if has_gender:
    plt.figure(figsize=(8, 5))
    sns.boxplot(data=admission_df, x='Gender', y='los', palette='Set3')
    plt.title('üì¶ Boxplot th·ªùi gian n·∫±m vi·ªán theo gi·ªõi t√≠nh')
    plt.xlabel('Gi·ªõi t√≠nh')
    plt.ylabel('S·ªë ng√†y')
    plt.grid(True)
    filename = "charts/box_gender.png"
    plt.savefig(filename, bbox_inches='tight')
    plt.close()
    print("‚úÖ ƒê√£ l∆∞u:", filename)

    with open(filename, "rb") as f:
        img_data = base64.b64encode(f.read()).decode("utf-8")
        img_tag = f'<img src="data:image/png;base64,{img_data}" style="margin-right:20px; width:700px; border:1px solid #ccc"/>'
        image_tags.append(img_tag)

# --- HISTOGRAM THEO NH√ìM TU·ªîI ---
if has_age_group:
    plt.figure(figsize=(10, 5))
    sns.histplot(data=admission_df, x='los', hue='age_group', multiple='stack', bins=30, kde=False, palette='tab10')
    plt.title('üìä Ph√¢n ph·ªëi th·ªùi gian n·∫±m vi·ªán theo nh√≥m tu·ªïi')
    plt.xlabel('S·ªë ng√†y n·∫±m vi·ªán')
    plt.ylabel('S·ªë b·ªánh nh√¢n')
    plt.grid(True)
    filename = "charts/hist_age.png"
    plt.savefig(filename, bbox_inches='tight')
    plt.close()
    print("‚úÖ ƒê√£ l∆∞u:", filename)

    with open(filename, "rb") as f:
        img_data = base64.b64encode(f.read()).decode("utf-8")
        img_tag = f'<img src="data:image/png;base64,{img_data}" style="margin-right:20px; width:700px; border:1px solid #ccc"/>'
        image_tags.append(img_tag)

# --- BOXPLOT THEO NH√ìM TU·ªîI ---
if has_age_group:
    plt.figure(figsize=(10, 5))
    sns.boxplot(data=admission_df, x='age_group', y='los', palette='pastel')
    plt.title('üì¶ Boxplot th·ªùi gian n·∫±m vi·ªán theo nh√≥m tu·ªïi')
    plt.xlabel('Nh√≥m tu·ªïi')
    plt.ylabel('S·ªë ng√†y n·∫±m vi·ªán')
    plt.grid(True)
    filename = "charts/box_age.png"
    plt.savefig(filename, bbox_inches='tight')
    plt.close()
    print("‚úÖ ƒê√£ l∆∞u:", filename)

    with open(filename, "rb") as f:
        img_data = base64.b64encode(f.read()).decode("utf-8")
        img_tag = f'<img src="data:image/png;base64,{img_data}" style="margin-right:20px; width:700px; border:1px solid #ccc"/>'
        image_tags.append(img_tag)

# --- HI·ªÇN TH·ªä (NOTEBOOK) ---
if image_tags:
    html_code = '<div style="display: flex; overflow-x: auto;">' + ''.join(image_tags) + '</div>'
    display(HTML(html_code))
else:
    print("‚ùå Kh√¥ng c√≥ h√¨nh ·∫£nh n√†o ƒë∆∞·ª£c hi·ªÉn th·ªã. Ki·ªÉm tra l·∫°i d·ªØ li·ªáu.")

"""# üîπ 3.3. Ph√¢n t√≠ch c√°c ch·∫©n ƒëo√°n k√®m theo (comorbidities)"""

# Ph√¢n t√≠ch c√°c ch·∫©n ƒëo√°n k√®m theo (comorbidities)

# L·∫•y t·∫•t c·∫£ ch·∫©n ƒëo√°n li√™n quan ƒë·∫øn admission_id trong nh√≥m thi·∫øu m√°u
all_diag_for_patients = diagnosis_df[diagnosis_df['admission_id'].isin(admission_df['admission_id'])]

# Lo·∫°i b·ªè c√°c m√£ thi·∫øu m√°u
comorbidities = all_diag_for_patients[~all_diag_for_patients['diagnosis'].isin(['D500', 'D508', 'D509'])]

# ƒê·∫øm t·∫ßn su·∫•t xu·∫•t hi·ªán v√† l·∫•y top 10
top10_comorbidities = comorbidities['diagnosis'].value_counts().head(10)

print("\n7. TOP 10 CH·∫®N ƒêO√ÅN K√àM THEO PH·ªî BI·∫æN NH·∫§T")
if not top10_comorbidities.empty:
    print(top10_comorbidities)

    # V·∫Ω bi·ªÉu ƒë·ªì
    plt.figure(figsize=(12, 6))
    top10_comorbidities.plot(kind='bar', color='teal')
    plt.title('Top 10 ch·∫©n ƒëo√°n k√®m theo ph·ªï bi·∫øn nh·∫•t')
    plt.xlabel('M√£ ch·∫©n ƒëo√°n')
    plt.ylabel('S·ªë l∆∞·ª£ng')
    plt.xticks(rotation=45)
    plt.tight_layout()
    plt.grid(True)
    plt.show()
else:
    print("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ch·∫©n ƒëo√°n k√®m theo n√†o ngo√†i thi·∫øu m√°u.")

print(all_diag_for_patients['diagnosis'].value_counts().head(20))

"""# üîπ 3.4. Ph√¢n t√≠ch ngu·ªìn nh·∫≠p vi·ªán"""

from IPython.display import display, HTML
import matplotlib.pyplot as plt
import seaborn as sns
import pandas as pd

# --- PH√ÇN T√çCH NGU·ªíN NH·∫¨P VI·ªÜN ---


# ƒê·∫øm v√† x·ª≠ l√Ω d·ªØ li·ªáu
admsource_dist = admission_df['admsource'].value_counts(dropna=False)
total = admsource_dist.sum()

if not admsource_dist.empty:
    admsource_labels = admsource_dist.index.astype(str)
    admsource_labels = ['Kh√¥ng r√µ' if x == 'nan' else f'Ngu·ªìn {x}' for x in admsource_labels]

    # T·∫°o b·∫£ng th·ªëng k√™
    admsource_df = pd.DataFrame({
        'Ngu·ªìn nh·∫≠p vi·ªán': admsource_labels,
        'S·ªë l∆∞·ª£ng': admsource_dist.values,
        'T·ª∑ l·ªá (%)': (100 * admsource_dist.values / total).round(2)
    })

    # Hi·ªÉn th·ªã b·∫£ng HTML ƒë·∫πp
    html_table = admsource_df.to_html(index=False, classes='table table-striped table-bordered', border=0)
    custom_style = """
    <style>
        h4.table-title {
            text-align: center;
            color: white;
            margin-top: 30px;
        }
        .table {
            width: 50%;
            margin: 0 auto 30px auto;
            border-collapse: collapse;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            color: #ffffff;
            background-color: #1e1e1e;
            border: 1px solid #444;
        }
        .table th {
            background-color: #2e2e2e;
            color: #00ffff;
            text-align: center;
            padding: 10px;
            border: 1px solid #555;
        }
        .table td {
            text-align: center;
            padding: 8px;
            border: 1px solid #444;
        }
        .table tbody tr:nth-child(even) {
            background-color: #2a2a2a;
        }
        .table tbody tr:nth-child(odd) {
            background-color: #1e1e1e;
        }
    </style>
    """


    # T·∫°o b·∫£ng HTML
    html_table = admsource_df.to_html(index=False, classes='table', border=0)

    # Hi·ªÉn th·ªã ti√™u ƒë·ªÅ v√† b·∫£ng cƒÉn gi·ªØa
    display(HTML(custom_style + "<h4 class='table-title'>üìã B·∫£ng ph√¢n b·ªë theo ngu·ªìn nh·∫≠p vi·ªán</h4>" + html_table))


    # V·∫Ω bi·ªÉu ƒë·ªì tr√≤n
    plt.figure(figsize=(8, 7))
    colors = sns.color_palette("pastel")[0:len(admsource_labels)]

    wedges, texts, autotexts = plt.pie(
        admsource_dist,
        labels=None,
        autopct='%1.1f%%',
        colors=colors,
        startangle=140,
        textprops={'fontsize': 10},
        pctdistance=0.75
    )

    # Th√™m ch√∫ gi·∫£i
    plt.legend(
        wedges,
        admsource_labels,
        title="Ngu·ªìn nh·∫≠p vi·ªán",
        loc="center left",
        bbox_to_anchor=(1, 0.5),
        fontsize=10
    )

    plt.title('Ph√¢n b·ªë theo ngu·ªìn nh·∫≠p vi·ªán', fontsize=14)
    plt.axis('equal')
    plt.tight_layout()
    plt.show()

else:
    print("‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu v·ªÅ ngu·ªìn nh·∫≠p vi·ªán.")

"""# üîπ3.5. Ph√¢n t√≠ch theo lo·∫°i nh·∫≠p vi·ªán"""

import matplotlib.pyplot as plt
import seaborn as sns
import pandas as pd
from IPython.display import HTML, display



# ƒê·∫øm s·ªë l∆∞·ª£ng t·ª´ng lo·∫°i
admtype_dist = admission_df['admtype'].value_counts(dropna=False)
total = admtype_dist.sum()

# G√°n nh√£n
admtype_labels = admtype_dist.index.astype(str)
admtype_labels = ['Kh√¥ng r√µ' if x == 'nan' else f'Lo·∫°i {x}' for x in admtype_labels]

# T·∫°o DataFrame
admtype_df = pd.DataFrame({
    'Lo·∫°i nh·∫≠p vi·ªán': admtype_labels,
    'S·ªë l∆∞·ª£ng': admtype_dist.values,
    'T·ª∑ l·ªá (%)': (100 * admtype_dist.values / total).round(2)
})

# In b·∫£ng console (tu·ª≥ ch·ªçn)
# print(admtype_df.to_string(index=False))

# V·∫Ω bi·ªÉu ƒë·ªì tr√≤n ƒë·∫πp
plt.figure(figsize=(8, 7))
colors = sns.color_palette("pastel")[0:len(admtype_labels)]

wedges, texts, autotexts = plt.pie(
    admtype_dist,
    labels=None,
    autopct='%1.1f%%',
    colors=colors,
    startangle=120,
    textprops={'fontsize': 10},
    pctdistance=0.75
)

plt.legend(
    wedges,
    admtype_labels,
    title="Lo·∫°i nh·∫≠p vi·ªán",
    loc="center left",
    bbox_to_anchor=(1, 0.5),
    fontsize=10
)

plt.title('Ph√¢n b·ªë theo lo·∫°i nh·∫≠p vi·ªán', fontsize=14)
plt.axis('equal')
plt.tight_layout()
plt.show()

# CSS b·∫£ng n·ªÅn ƒëen ‚Äì ch·ªØ tr·∫Øng ‚Äì cƒÉn gi·ªØa
custom_style = """
<style>
    h4.table-title {
        text-align: center;
        color: white;
        margin-top: 30px;
        font-family: Arial, sans-serif;
    }
    .table {
        width: 50%;
        margin: 0 auto 30px auto;
        border-collapse: collapse;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 14px;
        color: #ffffff;
        background-color: #1e1e1e;
        border: 1px solid #444;
    }
    .table th {
        background-color: #2e2e2e;
        color: #00ffff;
        text-align: center;
        padding: 10px;
        border: 1px solid #555;
    }
    .table td {
        text-align: center;
        padding: 8px;
        border: 1px solid #444;
    }
    .table tbody tr:nth-child(even) {
        background-color: #2a2a2a;
    }
    .table tbody tr:nth-child(odd) {
        background-color: #1e1e1e;
    }
</style>
"""

# Hi·ªÉn th·ªã b·∫£ng HTML ƒë·∫πp
html_table = admtype_df.to_html(index=False, classes='table', border=0)
display(HTML(custom_style + "<h4 class='table-title'>üìã B·∫£ng ph√¢n b·ªë theo lo·∫°i nh·∫≠p vi·ªán</h4>" + html_table))

"""# üîπ3.6. Ph√¢n t√≠ch th·ªùi gian n·∫±m vi·ªán theo nh√≥m tu·ªïi"""

# T√≠nh th·ªùi gian n·∫±m vi·ªán trung b√¨nh theo nh√≥m tu·ªïi
los_by_age = admission_df.groupby('age_group')['los'].mean().sort_values(ascending=False).round(1)

# Chuy·ªÉn th√†nh DataFrame ƒë·ªÉ hi·ªÉn th·ªã ƒë·∫πp h∆°n
los_by_age_table = los_by_age.reset_index()
los_by_age_table.columns = ['Nh√≥m tu·ªïi', 'S·ªë ng√†y n·∫±m vi·ªán trung b√¨nh']

# Hi·ªÉn th·ªã b·∫£ng
from IPython.display import display
display(los_by_age_table)

# V·∫Ω bi·ªÉu ƒë·ªì
plt.figure(figsize=(10, 6))
sns.barplot(data=los_by_age_table, x='Nh√≥m tu·ªïi', y='S·ªë ng√†y n·∫±m vi·ªán trung b√¨nh', order=los_by_age_table['Nh√≥m tu·ªïi'])
plt.title('Th·ªùi gian n·∫±m vi·ªán trung b√¨nh theo nh√≥m tu·ªïi')
plt.xlabel('Nh√≥m tu·ªïi')
plt.ylabel('S·ªë ng√†y n·∫±m vi·ªán trung b√¨nh')
plt.xticks(rotation=0)
plt.grid(axis='y', linestyle='--', alpha=0.7)
plt.tight_layout()
plt.show()

"""# üîπ3.7. Ph√¢n t√≠ch theo DRG code (m√£ nh√≥m b·ªánh)"""

# ƒê·∫øm t·∫ßn su·∫•t xu·∫•t hi·ªán c·ªßa m√£ DRG
drg_dist = admission_df['nat_drg_code'].value_counts().head(10)

# Chuy·ªÉn th√†nh DataFrame
drg_table = drg_dist.reset_index()
drg_table.columns = ['M√£ DRG', 'S·ªë ca']

# Hi·ªÉn th·ªã b·∫£ng
from IPython.display import display
display(drg_table)

# V·∫Ω bi·ªÉu ƒë·ªì
plt.figure(figsize=(12, 6))
sns.barplot(data=drg_table, x='M√£ DRG', y='S·ªë ca', palette='Purples_d')
plt.title('Top 10 m√£ nh√≥m b·ªánh ph·ªï bi·∫øn nh·∫•t')
plt.xlabel('M√£ DRG')
plt.ylabel('S·ªë l∆∞·ª£ng b·ªánh nh√¢n')
plt.xticks(rotation=45)
plt.grid(axis='y', linestyle='--', alpha=0.7)
plt.tight_layout()
plt.show()

"""# üîπ3.8. Ph√¢n t√≠ch v·ªã tr√≠ ch·∫©n ƒëo√°n thi·∫øu m√°u trong danh s√°ch ch·∫©n ƒëo√°n"""

# T√≠nh t·∫ßn su·∫•t t·ª´ng v·ªã tr√≠ ch·∫©n ƒëo√°n
position_dist = diagnosis_df['position'].value_counts().sort_index()

# Chuy·ªÉn th√†nh DataFrame ƒë·ªÉ tr√¨nh b√†y ƒë·∫πp h∆°n
position_table = position_dist.reset_index()
position_table.columns = ['V·ªã tr√≠ ch·∫©n ƒëo√°n', 'S·ªë ca']

# Hi·ªÉn th·ªã b·∫£ng
from IPython.display import display
display(position_table)

# V·∫Ω bi·ªÉu ƒë·ªì
plt.figure(figsize=(10, 6))
sns.barplot(data=position_table, x='V·ªã tr√≠ ch·∫©n ƒëo√°n', y='S·ªë ca', palette='Oranges_d')
plt.title('Ph√¢n b·ªë v·ªã tr√≠ ch·∫©n ƒëo√°n thi·∫øu m√°u trong danh s√°ch ch·∫©n ƒëo√°n')
plt.xlabel('V·ªã tr√≠ ch·∫©n ƒëo√°n (1 = ch√≠nh, 2+ = ph·ª•)')
plt.ylabel('S·ªë l∆∞·ª£ng b·ªánh nh√¢n')
plt.xticks(rotation=0)
plt.grid(axis='y', linestyle='--', alpha=0.7)
plt.tight_layout()
plt.show()

"""# üîπ3.9. ƒê√°nh gi√° ch·∫•t l∆∞·ª£ng d·ªØ li·ªáu"""

# T·ª∑ l·ªá thi·∫øu trong b·∫£ng admission
missing_admission = admission_df.isnull().mean().sort_values(ascending=False).reset_index()
missing_admission.columns = ['T√™n bi·∫øn', 'T·ª∑ l·ªá thi·∫øu']
missing_admission['T·ª∑ l·ªá thi·∫øu (%)'] = (missing_admission['T·ª∑ l·ªá thi·∫øu'] * 100).round(1)
missing_admission = missing_admission.drop(columns='T·ª∑ l·ªá thi·∫øu')

print("\nüìã B·∫¢NG: T·ª∑ l·ªá d·ªØ li·ªáu thi·∫øu trong b·∫£ng admission")
from IPython.display import display
display(missing_admission)

# T·ª∑ l·ªá thi·∫øu trong b·∫£ng diagnosis
missing_diagnosis = diagnosis_df.isnull().mean().sort_values(ascending=False).reset_index()
missing_diagnosis.columns = ['T√™n bi·∫øn', 'T·ª∑ l·ªá thi·∫øu']
missing_diagnosis['T·ª∑ l·ªá thi·∫øu (%)'] = (missing_diagnosis['T·ª∑ l·ªá thi·∫øu'] * 100).round(1)
missing_diagnosis = missing_diagnosis.drop(columns='T·ª∑ l·ªá thi·∫øu')

print("\nüìã B·∫¢NG: T·ª∑ l·ªá d·ªØ li·ªáu thi·∫øu trong b·∫£ng diagnosis")
display(missing_diagnosis)

"""# üîπ3.10. Ph√¢n t√≠ch s√¢u theo lo·∫°i thi·∫øu m√°u"""

# G·ªôp d·ªØ li·ªáu
merged_df = admission_df.merge(diagnosis_df[['admission_id', 'diagnosis']], on='admission_id', how='left')

# B·∫£ng ph√¢n b·ªë gi·ªõi t√≠nh theo lo·∫°i thi·∫øu m√°u
gender_by_diag = pd.crosstab(merged_df['diagnosis'], merged_df['Gender'].replace({1: 'Nam', 2: 'N·ªØ'}))
print("\nüë´ B·∫¢NG: Ph√¢n b·ªë gi·ªõi t√≠nh theo lo·∫°i thi·∫øu m√°u")
display(gender_by_diag)

# V·∫Ω bi·ªÉu ƒë·ªì
plt.figure(figsize=(10, 6))
gender_by_diag.plot(kind='bar', stacked=True)
plt.title('Ph√¢n b·ªë gi·ªõi t√≠nh theo lo·∫°i thi·∫øu m√°u')
plt.xlabel('Lo·∫°i thi·∫øu m√°u')
plt.ylabel('S·ªë l∆∞·ª£ng b·ªánh nh√¢n')
plt.xticks(rotation=0)
plt.legend(title='Gi·ªõi t√≠nh')
plt.tight_layout()
plt.show()

# B·∫£ng ph√¢n b·ªë ƒë·ªô tu·ªïi theo lo·∫°i thi·∫øu m√°u
age_by_diag = pd.crosstab(merged_df['diagnosis'], merged_df['age_group'])
print("\nüéÇ B·∫¢NG: Ph√¢n b·ªë ƒë·ªô tu·ªïi theo lo·∫°i thi·∫øu m√°u")
display(age_by_diag)

# V·∫Ω bi·ªÉu ƒë·ªì
plt.figure(figsize=(12, 6))
age_by_diag.plot(kind='bar', stacked=True)
plt.title('Ph√¢n b·ªë ƒë·ªô tu·ªïi theo lo·∫°i thi·∫øu m√°u')
plt.xlabel('Lo·∫°i thi·∫øu m√°u')
plt.ylabel('S·ªë l∆∞·ª£ng b·ªánh nh√¢n')
plt.xticks(rotation=0)
plt.legend(title='Nh√≥m tu·ªïi')
plt.tight_layout()
plt.show()

# B·∫£ng th·ªùi gian n·∫±m vi·ªán trung b√¨nh theo lo·∫°i thi·∫øu m√°u
los_by_diag = merged_df.groupby('diagnosis')['los'].mean().round(1).reset_index()
los_by_diag.columns = ['Lo·∫°i thi·∫øu m√°u', 'S·ªë ng√†y n·∫±m vi·ªán trung b√¨nh']
print("\nüõèÔ∏è B·∫¢NG: Th·ªùi gian n·∫±m vi·ªán trung b√¨nh theo lo·∫°i thi·∫øu m√°u")
display(los_by_diag)

# V·∫Ω bi·ªÉu ƒë·ªì
plt.figure(figsize=(10, 6))
sns.barplot(data=los_by_diag, x='Lo·∫°i thi·∫øu m√°u', y='S·ªë ng√†y n·∫±m vi·ªán trung b√¨nh', palette='Blues_d')
plt.title('Th·ªùi gian n·∫±m vi·ªán trung b√¨nh theo lo·∫°i thi·∫øu m√°u')
plt.xlabel('Lo·∫°i thi·∫øu m√°u')
plt.ylabel('S·ªë ng√†y trung b√¨nh')
plt.tight_layout()
plt.show()

"""# üîπ3.11. Ph√¢n t√≠ch theo m√πa(n·∫øu c√≥ d·ªØ li·ªáu ng√†y)"""

# Ph√¢n t√≠ch theo m√πa (n·∫øu c√≥ d·ªØ li·ªáu ng√†y)
# Gi·∫£ s·ª≠ admission_id ch·ª©a th√¥ng tin ng√†y (2 ch·ªØ s·ªë ƒë·∫ßu l√† nƒÉm, 2 ti·∫øp theo l√† th√°ng)
try:
    # Tr√≠ch xu·∫•t nƒÉm-th√°ng t·ª´ admission_id
    merged_df['admission_date'] = pd.to_datetime(merged_df['admission_id'].astype(str).str[:4], format='%y%m', errors='coerce')
    merged_df['month'] = merged_df['admission_date'].dt.month

    # ƒê·∫øm s·ªë ca theo th√°ng
    monthly_dist = merged_df['month'].value_counts().sort_index()

    # Chuy·ªÉn sang DataFrame ƒë·ªÉ hi·ªÉn th·ªã ƒë·∫πp h∆°n
    monthly_table = pd.DataFrame({
        'Th√°ng': monthly_dist.index,
        'S·ªë ca nh·∫≠p vi·ªán': monthly_dist.values
    }).sort_values('Th√°ng')

    # In b·∫£ng
    print("\nüìÖ 15. B·∫¢NG PH√ÇN B·ªê S·ªê CA NH·∫¨P VI·ªÜN THEO TH√ÅNG:\n")
    print(monthly_table.to_string(index=False))

    # V·∫Ω bi·ªÉu ƒë·ªì
    plt.figure(figsize=(10, 6))
    plt.bar(monthly_table['Th√°ng'], monthly_table['S·ªë ca nh·∫≠p vi·ªán'], color='darkblue')
    plt.title('Ph√¢n b·ªë s·ªë ca nh·∫≠p vi·ªán theo th√°ng')
    plt.xlabel('Th√°ng')
    plt.ylabel('S·ªë l∆∞·ª£ng b·ªánh nh√¢n')
    plt.xticks(monthly_table['Th√°ng'])
    plt.grid(axis='y', linestyle='--', alpha=0.7)
    plt.show()

except Exception as e:
    print("\n‚ö†Ô∏è Kh√¥ng th·ªÉ tr√≠ch xu·∫•t th√¥ng tin ng√†y t·ª´ d·ªØ li·ªáu:", e)

"""# üîπ3.12. Ph√¢n t√≠ch ma tr·∫≠n t∆∞∆°ng quan gi·ªØa tu·ªïi, th·ªùi gian n·∫±m vi·ªán v√† c√¢n n·∫∑ng"""

import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import statsmodels.api as sm

# T√≠nh to√°n ma tr·∫≠n t∆∞∆°ng quan
correlation_matrix = admission_df[['age_years', 'los', 'weight']].corr()
plt.figure(figsize=(10, 6))
sns.heatmap(correlation_matrix, annot=True, cmap='coolwarm', center=0)
plt.title(' Ma tr·∫≠n t∆∞∆°ng quan gi·ªØa tu·ªïi, th·ªùi gian n·∫±m vi·ªán v√† c√¢n n·∫∑ng')
plt.show()

# M√£ h√≥a gi·ªõi t√≠nh: Nam = 0, N·ªØ = 1 (n·∫øu ch∆∞a c√≥ c·ªôt m√£ h√≥a)
if 'Gender_code' not in admission_df.columns:
    admission_df['Gender_code'] = admission_df['Gender'].map({'Nam': 0, 'N·ªØ': 1})

# Chu·∫©n b·ªã d·ªØ li·ªáu cho h·ªìi quy tuy·∫øn t√≠nh
reg_df = admission_df[['age_years', 'Gender_code', 'los']].dropna()

X = reg_df[['age_years', 'Gender_code']]
X = sm.add_constant(X)  # th√™m h·ªá s·ªë ch·∫∑n
y = reg_df['los']

# H·ªìi quy tuy·∫øn t√≠nh
model = sm.OLS(y, X).fit()

# In k·∫øt qu·∫£
print(model.summary())

import pandas as pd
import numpy as np
import seaborn as sns
import matplotlib.pyplot as plt
from scipy.stats import f_oneway

# Ph√¢n nh√≥m tu·ªïi
bins = [0, 10, 20, 30, 40, 50, 60, np.inf]
labels = ["0-9", "10-19", "20-29", "30-39", "40-49", "50-59", "60+"]
admission_df["age_group"] = pd.cut(admission_df["age_years"], bins=bins, labels=labels, right=False)

# Ki·ªÉm ƒë·ªãnh ANOVA
anova_data = admission_df.dropna(subset=["age_group", "los"])
groups = [group["los"].values for _, group in anova_data.groupby("age_group")]
f_stat, p_value = f_oneway(*groups)

print("üîç K·∫øt qu·∫£ ki·ªÉm ƒë·ªãnh ANOVA:")
print(f"F-statistic: {f_stat:.2f}")
print(f"P-value: {p_value:.4f}")
if p_value < 0.05:
    print("üëâ C√≥ s·ª± kh√°c bi·ªát c√≥ √Ω nghƒ©a th·ªëng k√™ gi·ªØa c√°c nh√≥m tu·ªïi.")
else:
    print("üëâ Kh√¥ng c√≥ s·ª± kh√°c bi·ªát ƒë√°ng k·ªÉ gi·ªØa c√°c nh√≥m tu·ªïi.")

# Ma tr·∫≠n t∆∞∆°ng quan
corr_matrix = admission_df[["los", "age_years", "weight"]].corr()
sns.heatmap(corr_matrix, annot=True, cmap="coolwarm")
plt.title(" Ma tr·∫≠n t∆∞∆°ng quan gi·ªØa LOS, tu·ªïi v√† c√¢n n·∫∑ng")
plt.show()

"""# üîπ3.13. Ph√¢n t√≠ch theo nh√≥m nguy c∆° cao"""

import pandas as pd

# Nh√≥m b·ªánh nh√¢n c√≥ th·ªùi gian n·∫±m vi·ªán d√†i b·∫•t th∆∞·ªùng (LOS > 30 ng√†y)
high_risk = admission_df[admission_df['los'] > 30]
normal_risk = admission_df[admission_df['los'] <= 30]

# T√≠nh to√°n c√°c ch·ªâ s·ªë cho t·ª´ng nh√≥m
comparison_table = pd.DataFrame({
    'High Risk': {
        'S·ªë l∆∞·ª£ng': len(high_risk),
        'ƒê·ªô tu·ªïi trung b√¨nh': high_risk['age_years'].mean(),
        'T·ª∑ l·ªá n·ªØ (%)': (high_risk['Gender'] == 2).mean() * 100,
        'Th·ªùi gian n·∫±m vi·ªán TB': high_risk['los'].mean()
    },
    'Normal Risk': {
        'S·ªë l∆∞·ª£ng': len(normal_risk),
        'ƒê·ªô tu·ªïi trung b√¨nh': normal_risk['age_years'].mean(),
        'T·ª∑ l·ªá n·ªØ (%)': (normal_risk['Gender'] == 2).mean() * 100,
        'Th·ªùi gian n·∫±m vi·ªán TB': normal_risk['los'].mean()
    }
})

# Hi·ªÉn th·ªã b·∫£ng
print("üìä B·∫£ng so s√°nh nh√≥m nguy c∆° cao vs nh√≥m th√¥ng th∆∞·ªùng:\n")
print(comparison_table.round(1))

"""# üîπ3.14. X√¢y d·ª±ng m√¥ h√¨nh d·ª± ƒëo√°n (Machine Learning)"""

from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split
from sklearn.metrics import classification_report, confusion_matrix, ConfusionMatrixDisplay
import matplotlib.pyplot as plt
import seaborn as sns
import pandas as pd
import numpy as np

# üåü B∆∞·ªõc 1: M√£ h√≥a gi·ªõi t√≠nh (Nam = 0, N·ªØ = 1)
admission_df['Gender_code'] = admission_df['Gender'].map({'Nam': 0, 'N·ªØ': 1})

# üåü B∆∞·ªõc 2: T·∫°o bi·∫øn m·ª•c ti√™u: n·∫±m vi·ªán d√†i ng√†y (>7 ng√†y)
admission_df['long_stay'] = (admission_df['los'] > 7).astype(int)

# üåü B∆∞·ªõc 3: Ch·ªçn c√°c bi·∫øn ƒë·∫ßu v√†o
X = admission_df[['age_years', 'Gender_code', 'weight']].fillna(0)
y = admission_df['long_stay']

# üåü B∆∞·ªõc 4: Chia d·ªØ li·ªáu v√† hu·∫•n luy·ªán m√¥ h√¨nh
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.3, random_state=42)

model = RandomForestClassifier(random_state=42)
model.fit(X_train, y_train)

# üåü B∆∞·ªõc 5: ƒê√°nh gi√° m√¥ h√¨nh
accuracy = model.score(X_test, y_test)
print(f"‚úÖ ƒê·ªô ch√≠nh x√°c c·ªßa m√¥ h√¨nh Random Forest: {accuracy:.2%}")

# ‚ö° Classification report (Precision, Recall, F1)
y_pred = model.predict(X_test)
print("\nüîç B√°o c√°o ph√¢n lo·∫°i:\n")
print(classification_report(y_test, y_pred))

# üìä Confusion matrix
cm = confusion_matrix(y_test, y_pred)
disp = ConfusionMatrixDisplay(confusion_matrix=cm, display_labels=["<=7 ng√†y", ">7 ng√†y"])
disp.plot(cmap='Blues')
plt.title("Ma tr·∫≠n nh·∫ßm l·∫´n - Random Forest")
plt.grid(False)
plt.show()

# üìà Feature importance (gi·ªëng varImp b√™n R)
feat_imp = pd.Series(model.feature_importances_, index=X.columns).sort_values(ascending=True)

plt.figure(figsize=(6, 4))
feat_imp.plot(kind='barh', color='teal')
plt.title("M·ª©c ƒë·ªô quan tr·ªçng c·ªßa bi·∫øn (Feature Importance)")
plt.xlabel("T·∫ßm quan tr·ªçng")
plt.tight_layout()
plt.show()

# T·∫°o eval_df n·∫øu ch∆∞a c√≥
eval_df = pd.DataFrame({
    "Actual": y_test,
    "Predicted": model.predict(X_test)
})
eval_df["Residual"] = eval_df["Actual"] - eval_df["Predicted"]

# 1Ô∏è‚É£ Bi·ªÉu ƒë·ªì scatter: D·ª± ƒëo√°n vs Th·ª±c t·∫ø
plt.figure(figsize=(8, 6))
sns.scatterplot(data=eval_df, x="Actual", y="Predicted", color="steelblue", alpha=0.6)
plt.plot([eval_df["Actual"].min(), eval_df["Actual"].max()],
         [eval_df["Actual"].min(), eval_df["Actual"].max()],
         color='red', linestyle='--', label="D·ª± ƒëo√°n ho√†n h·∫£o")
plt.title("üîπ D·ª± ƒëo√°n LOS vs. Gi√° tr·ªã th·ª±c t·∫ø")
plt.xlabel("LOS th·ª±c t·∫ø")
plt.ylabel("LOS d·ª± ƒëo√°n")
plt.legend()
plt.grid(True)
plt.tight_layout()
plt.show()

# 2Ô∏è‚É£ Bi·ªÉu ƒë·ªì residuals: Sai s·ªë d·ª± ƒëo√°n
plt.figure(figsize=(8, 6))
sns.scatterplot(data=eval_df, x="Predicted", y="Residual", color="darkorange", alpha=0.6)
plt.axhline(y=0, color='gray', linestyle='--')
plt.title("üî∏ Ph√¢n t√≠ch sai s·ªë d·ª± ƒëo√°n (Residuals)")
plt.xlabel("LOS d·ª± ƒëo√°n")
plt.ylabel("Sai s·ªë (Residual)")
plt.grid(True)
plt.tight_layout()
plt.show()

from scipy.stats import ttest_ind

# Ki·ªÉm tra s·ª± kh√°c bi·ªát th·ªùi gian n·∫±m vi·ªán gi·ªØa nam v√† n·ªØ
male_los = admission_df[admission_df['Gender'] == 1]['los']
female_los = admission_df[admission_df['Gender'] == 2]['los']
t_stat, p_value = ttest_ind(male_los, female_los, nan_policy='omit')

print(f"Ki·ªÉm ƒë·ªãnh t-test:\nT-statistic = {t_stat:.3f}, p-value = {p_value:.4f}")
if p_value < 0.05:
    print("C√≥ s·ª± kh√°c bi·ªát c√≥ √Ω nghƒ©a th·ªëng k√™")
else:
    print("Kh√¥ng c√≥ s·ª± kh√°c bi·ªát c√≥ √Ω nghƒ©a")

from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import classification_report, confusion_matrix

# X√¢y nh√£n: LOS > 7 ƒë∆∞·ª£c coi l√† "n·∫±m vi·ªán l√¢u"
admission_df["long_stay"] = (admission_df["los"] > 7).astype(int)

# Bi·∫øn ƒë·∫ßu v√†o
X = admission_df[["age_years", "weight"]].fillna(0)
y = admission_df["long_stay"]

# Chia t·∫≠p train/test
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# Hu·∫•n luy·ªán m√¥ h√¨nh
model = RandomForestClassifier(random_state=42)
model.fit(X_train, y_train)

# D·ª± ƒëo√°n v√† ƒë√°nh gi√°
y_pred = model.predict(X_test)
print("üìà B√°o c√°o m√¥ h√¨nh:")
print(classification_report(y_test, y_pred))
print("üîç Ma tr·∫≠n nh·∫ßm l·∫´n:")
print(confusion_matrix(y_test, y_pred))